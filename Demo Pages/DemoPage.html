<!DOCTYPE html>
<html>
	<head>
		<!-- links stylesheet -->
		<link type="text/css" rel="stylesheet" href="stylesheet.css">
		
		<!-- Adds the title -->
		<title>Trainlink API Demo</title>
	</head>
	<body>
		<!-- links backend -->
		<script src="trainlink.js"></script>
		
		<!--Main content -->
		<h1>Trainlink API Demo</h1>
		
		<!-- Shows active train -->
		<h2 id="trainName">Select a Train</h2>
		<br>
		
		<!-- Speed control slider -->
		<div class="slideContainer">
			<p id="speedValue">0</p>
			<input type="range" min="-126" max="126" value="0" class="slider" id="speedControl"> 
		</div>
		
		<br>
		
		<!-- Break buttons -->
		<div class="breakContainer">
			<button>Stop</button>
			<button>Emergency Stop</button>
		</div>
		
		<br>

		<div id="cabList"></div>

		<script>
			initiateTrainLink("ws://127.0.0.1:6789");
			
			var slider = document.getElementById("speedControl"),
				title = document.getElementById("trainName"),
				speedValue = document.getElementById("speedValue")
				cabSpeeds = [],
				cabDirections = [],
				activeCab = "",
				cabList = document.getElementById("cabList");
			
			slider.disabled = true;
			
			slider.oninput = function (event) {
				setSpeed(activeCab,slider.value);
			}
			
			function config(data) {
				cabs = data.cabs
				cabKeys = Object.keys(cabs);
				cabValues = Object.values(cabs);
				cabButtons = [];
				for (cabNum = 0; cabNum < cabKeys.length; cabNum++) {
					cabSpeeds[cabKeys[cabNum]] = "0"
					cabButtons.push(document.createElement("BUTTON"));
					cabButtons[cabNum].innerHTML = cabKeys[cabNum];
					cabButtons[cabNum].setAttribute("onclick", "changeCab(\""+cabKeys[cabNum]+"\")");
					cabList.appendChild(cabButtons[cabNum]);
					cabList.appendChild(document.createTextNode("\t"));
				}
				//console.log(cabSpeeds)
			}

			function update(data) {
				cabID  = cabValues.findIndex(searchArray, data.cab);
				cabDirections[cabKeys[cabID]] = data.direction;
				cabSpeeds[cabKeys[cabID]] = data.speed;
				if (!(cabDirections[cabKeys[cabID]]) && cabSpeeds[cabKeys[cabID]] != 0){
					cabSpeeds[cabKeys[cabID]] = "-" + String(cabSpeeds[cabKeys[cabID]]);
				}
				if (cabSpeeds[activeCab] != undefined) {
					speedValue.innerHTML = cabSpeeds[activeCab];
					slider.value = cabSpeeds[activeCab];
				}
			}
			
			function searchArray(current) {
				return current == this;
			}

			function changeCab(cabName) {
				slider.disabled = false;
				title.innerHTML = cabName;
				activeCab = cabName;
				slider.value = cabSpeeds[activeCab];
				speedValue.innerHTML = cabSpeeds[activeCab];
			}
		</script>
	</body>
</html>