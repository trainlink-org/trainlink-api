<!DOCTYPE html>
<html>
	<head>
		<!-- links stylesheet -->
		<link type="text/css" rel="stylesheet" href="stylesheet.css">
		
		<!-- Adds the title -->
		<title>Trainlink API Demo</title>
	</head>
	<body>
		<!-- links backend -->
		<script src="../API Libraries/TrainLink for Websites/trainlink.js"></script>
		
		<!--Main content -->
		<h1>Trainlink API Demo</h1>
		
		<!-- Shows active train -->
		<h2 id="trainName">Select a Train</h2>
		<br>
		
		<!-- Speed control slider -->
		<div class="slideContainer">
			<p id="speedValue">0</p>
			<input type="range" min="-126" max="126" value="0" class="slider" id="speedControl"> 
		</div>
		
		<br>
		
		<!-- Break buttons -->
		<div class="breakContainer">
			<button onclick="trainlink.stopCab(activeCab)">Stop</button>
			<button onclick="estopCab(activeCab)">Emergency Stop</button>
		</div>
		
		<br>

		<!-- Where the cab buttons will be located -->
		<div id="cabList"></div>

		<script>
			trainlink()
			/* Creates the web socket */
			trainlink.initiateTrainLink("ws://127.0.0.1:6789");
			
			/* Sets up required variables */
			var slider = document.getElementById("speedControl"),
				title = document.getElementById("trainName"),
				speedValue = document.getElementById("speedValue")
				cabSpeeds = [],
				cabDirections = [],
				activeCab = "",
				cabList = document.getElementById("cabList");
			
			/* Stops slider being used when no cab selected */
			slider.disabled = true;
			
			/* deals with the slider changing */
			slider.oninput = function (event) {
				trainlink.setSpeed(activeCab,slider.value);
			}

			/* 	The config function
				This is called when the websocket is created and the first packet is recived
			*/
			function config(data) {
				/* The packet recived from the server is passed in as the data variable (this can be called anything)*/
				
				/* Stores the cabs list from the server */
				cabs = data.cabs
				/*	cabKeys stores the cab names, cabValues the address 
					corresponding names and addresses have the same index number in both arrays */
				cabKeys = Object.keys(cabs);
				cabValues = Object.values(cabs);
				/* Stores the buttons to switch cabs */
				cabButtons = [];
				/* Goes through each cab and gives it a button as well as an entry in cabSpeeds*/
				for (cabNum = 0; cabNum < cabKeys.length; cabNum++) {
					/* creates entry in cabSpeeds (speed is set to 0) */
					cabSpeeds[cabKeys[cabNum]] = "0"
					/* creates a button*/
					cabButtons.push(document.createElement("BUTTON"));
					cabButtons[cabNum].innerHTML = cabKeys[cabNum];
					/* adds the onclick */
					cabButtons[cabNum].setAttribute("onclick", "changeCab(\""+cabKeys[cabNum]+"\")");
					cabList.appendChild(cabButtons[cabNum]);
					cabList.appendChild(document.createTextNode("\t"));
				}
			}

			/* 	The update function
				This is called when the websocket recives a packet from the server with a state update
			*/
			function update(data) {
				/* The packet recived from the server is passed in as the data variable (this can be called anything)*/

				/* Finds the array address of the cab that the data packet is for */
				cabID  = cabValues.findIndex(searchArray, data.cab);
				/* Sets the cab's direction and speed */
				cabDirections[cabKeys[cabID]] = data.direction;
				cabSpeeds[cabKeys[cabID]] = data.speed;
				/* If the cab is reversing, adds a minus in front of the displayed speed */
				if (!(cabDirections[cabKeys[cabID]]) && cabSpeeds[cabKeys[cabID]] != 0){
					cabSpeeds[cabKeys[cabID]] = "-" + String(cabSpeeds[cabKeys[cabID]]);
				}
				/* Updates the slider and value on the website if the speed isnt 'undefined' */
				if (cabSpeeds[activeCab] != undefined) {
					speedValue.innerHTML = cabSpeeds[activeCab];
					slider.value = cabSpeeds[activeCab];
				}
			}
			
			/* Used in the update function to find the id of the cab */
			function searchArray(current) {
				return current == this;
			}

			/* Used to change the active cab and updates all values accordingly */
			function changeCab(cabName) {
				slider.disabled = false;
				title.innerHTML = cabName;
				activeCab = cabName;
				slider.value = cabSpeeds[activeCab];
				speedValue.innerHTML = cabSpeeds[activeCab];
			}
		</script>
	</body>
</html>